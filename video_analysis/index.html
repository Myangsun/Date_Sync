<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DateSync - Dual Video Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="visualization.js"></script>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        margin: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .upload-section {
        margin: 10px 0;
        padding: 10px;
        background: #f9f9f9;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .video-row {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-bottom: 20px;
      }
      .video-block {
        width: 45%;
      }
      video {
        width: 100%;
        border: 1px solid #ccc;
        margin-bottom: 10px;
      }
      .feedback {
        text-align: left;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        max-height: 300px;
        overflow-y: auto;
        font-size: 14px;
      }
      .time-slider-container {
        width: 90%;
        margin: 10px auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .time-slider {
        width: 90%;
        margin: 5px 0;
      }
      .compatibility-score {
        font-size: 24px;
        font-weight: bold;
        margin: 15px;
        padding: 10px;
        border-radius: 10px;
        background: linear-gradient(45deg, #f3ec78, #af4261);
        color: white;
      }
      .metric {
        font-weight: bold;
        font-size: 14px;
      }
      .time-display {
        font-size: 14px;
        margin: 2px 0;
      }
      .chart-wrapper {
        width: 100%;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-top: 10px;
        height: 200px;
      }
      .metrics-image {
        width: 100%;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .file-upload {
        display: flex;
        align-items: center;
        margin: 0 10px;
      }
      .file-label {
        margin-right: 5px;
        font-size: 14px;
      }
      .dashboard {
        display: flex;
        justify-content: space-around;
        margin-top: 5px;
        font-size: 14px;
      }
      .detailed-analysis {
        text-align: left;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }
      .status-indicator {
        margin: 10px auto;
        padding: 8px;
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 4px;
        color: #856404;
        font-size: 14px;
        text-align: center;
        display: none;
      }
      .progress-bar {
        width: 100%;
        height: 10px;
        background-color: #e9ecef;
        border-radius: 4px;
        margin-top: 5px;
        overflow: hidden;
      }
      .progress {
        height: 100%;
        background-color: #4caf50;
        width: 0%;
        transition: width 0.3s;
      }
      button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 8px 15px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 0 10px;
        cursor: pointer;
        border-radius: 4px;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>DateSync</h1>
    <p>Dual Video Multimodal Emotion Analysis</p>

    <div class="upload-section">
      <div class="file-upload">
        <span class="file-label">Video 1:</span>
        <input type="file" id="video1-upload" accept="video/*" />
      </div>
      <div class="file-upload">
        <span class="file-label">Video 2:</span>
        <input type="file" id="video2-upload" accept="video/*" />
      </div>
      <button id="analyze-btn" disabled>Analyze</button>
    </div>

    <div class="status-indicator" id="status-indicator">
      Analysis may take several minutes to complete. Please wait...
    </div>

    <div class="compatibility-score" id="compatibility-score">
      Date Compatibility Score: --
    </div>

    <div class="time-slider-container">
      <div class="time-display">Time: <span id="current-time">0</span>s</div>
      <input
        type="range"
        min="0"
        max="100"
        value="0"
        class="time-slider"
        id="time-slider"
      />
      <button id="play-btn">Play Both</button>
    </div>

    <div class="video-row">
      <div class="video-block">
        <h2>Video 1</h2>
        <video id="video1" controls>
          Your browser does not support the video tag.
        </video>
        <div class="dashboard">
          <div>Valence: <span id="val1" class="metric">-</span></div>
          <div>Comfort: <span id="com1" class="metric">-</span></div>
          <div>Engagement: <span id="eng1" class="metric">-</span></div>
        </div>
        <div class="feedback">
          <h3>Feedback Video 1</h3>
          <p id="text1">Upload and analyze videos to see feedback</p>
        </div>
        <div class="chart-wrapper">
          <canvas id="chart1"></canvas>
        </div>
        <img
          id="metrics-img1"
          class="metrics-image"
          style="display: none"
          alt="Video 1 Metrics Over Time"
        />
      </div>

      <div class="video-block">
        <h2>Video 2</h2>
        <video id="video2" controls>
          Your browser does not support the video tag.
        </video>
        <div class="dashboard">
          <div>Valence: <span id="val2" class="metric">-</span></div>
          <div>Comfort: <span id="com2" class="metric">-</span></div>
          <div>Engagement: <span id="eng2" class="metric">-</span></div>
        </div>
        <div class="feedback">
          <h3>Feedback Video 2</h3>
          <p id="text2">Upload and analyze videos to see feedback</p>
        </div>
        <div class="chart-wrapper">
          <canvas id="chart2"></canvas>
        </div>
        <img
          id="metrics-img2"
          class="metrics-image"
          style="display: none"
          alt="Video 2 Metrics Over Time"
        />
      </div>
    </div>

    <div class="detailed-analysis" id="detailed-analysis">
      <h2>Compatibility Analysis</h2>
      <p>Upload and analyze videos to see detailed compatibility insights</p>
    </div>

    <script>
      // Global variables
      let data1 = [],
        data2 = [];
      let compatibilityScore = 0;

      // DOM elements
      const timeSlider = document.getElementById("time-slider");
      const currentTimeDisplay = document.getElementById("current-time");
      const video1Upload = document.getElementById("video1-upload");
      const video2Upload = document.getElementById("video2-upload");
      const analyzeBtn = document.getElementById("analyze-btn");
      const statusIndicator = document.getElementById("status-indicator");
      const playBtn = document.getElementById("play-btn");
      const v1 = document.getElementById("video1");
      const v2 = document.getElementById("video2");
      const metricsImg1 = document.getElementById("metrics-img1");
      const metricsImg2 = document.getElementById("metrics-img2");

      // Enable analyze button when both videos are uploaded
      function checkUploadStatus() {
        console.log("Checking upload status...");
        if (video1Upload.files.length > 0 && video2Upload.files.length > 0) {
          analyzeBtn.disabled = false;
        } else {
          analyzeBtn.disabled = true;
        }
      }

      // Add event listeners for file uploads
      video1Upload.addEventListener("change", function (e) {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          v1.src = URL.createObjectURL(file);
          checkUploadStatus();
        }
      });

      video2Upload.addEventListener("change", function (e) {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          v2.src = URL.createObjectURL(file);
          checkUploadStatus();
        }
      });

      // Handle form submission
      analyzeBtn.addEventListener("click", function () {
        if (video1Upload.files.length == 0 || video2Upload.files.length == 0) {
          return;
        }

        // Show status indicator
        const statusIndicator = document.getElementById("status-indicator");
        statusIndicator.style.display = "block";
        statusIndicator.innerHTML =
          "Analysis may take several minutes to complete. Please wait...";
        statusIndicator.style.backgroundColor = "#fff3cd";

        // Add progress bar
        statusIndicator.innerHTML +=
          '<div class="progress-bar"><div class="progress" id="progress-bar"></div></div>';
        const progressBar = document.getElementById("progress-bar");

        // Create FormData and upload videos
        const formData = new FormData();
        formData.append("video1", video1Upload.files[0]);
        formData.append("video2", video2Upload.files[0]);

        // Send data to server
        fetch("/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Upload successful:", data);

            // Start polling for status
            const statusInterval = setInterval(() => {
              fetch("/status")
                .then((res) => res.json())
                .then((statusData) => {
                  // Update progress bar
                  progressBar.style.width = statusData.progress + "%";

                  // Update status message based on progress
                  if (statusData.progress < 50) {
                    statusIndicator.innerHTML = `Analyzing videos (${statusData.progress}%)... This may take several minutes.`;
                    statusIndicator.innerHTML +=
                      '<div class="progress-bar"><div class="progress" id="progress-bar" style="width: ' +
                      statusData.progress +
                      '%;"></div></div>';
                  } else if (statusData.progress < 90) {
                    statusIndicator.innerHTML = `Calculating compatibility (${statusData.progress}%)...`;
                    statusIndicator.innerHTML +=
                      '<div class="progress-bar"><div class="progress" id="progress-bar" style="width: ' +
                      statusData.progress +
                      '%;"></div></div>';
                  } else {
                    statusIndicator.innerHTML = `Finishing up (${statusData.progress}%)...`;
                    statusIndicator.innerHTML +=
                      '<div class="progress-bar"><div class="progress" id="progress-bar" style="width: ' +
                      statusData.progress +
                      '%;"></div></div>';
                  }

                  // Check if processing is complete
                  if (statusData.status === "completed") {
                    clearInterval(statusInterval);
                    loadResults();
                    statusIndicator.style.display = "none";
                  } else if (statusData.status === "error") {
                    clearInterval(statusInterval);
                    statusIndicator.innerHTML =
                      "Error during analysis: " + statusData.message;
                    statusIndicator.style.backgroundColor = "#f8d7da";
                  }
                })
                .catch((err) => {
                  console.error("Error checking status:", err);
                });
            }, 2000); // Check every 2 seconds
          })
          .catch((error) => {
            console.error("Error uploading videos:", error);
            statusIndicator.innerHTML =
              "Error uploading videos. Please try again.";
            statusIndicator.style.backgroundColor = "#f8d7da";
          });
      });

      // Load results after processing is complete
      function loadResults() {
        console.log("Loading results...");

        const statusIndicator = document.getElementById("status-indicator");
        statusIndicator.style.display = "block";
        statusIndicator.innerHTML = "Loading analysis results...";
        statusIndicator.style.backgroundColor = "#d4edda";

        // Load all data
        Promise.all([
          fetch("output/video_1/metrics_data.json").then((res) =>
            res.json().catch(() => ({}))
          ),
          fetch("output/video_2/metrics_data.json").then((res) =>
            res.json().catch(() => ({}))
          ),
          fetch("output/video_1/crossmodal_analysis.txt").then((res) =>
            res.text().catch(() => "")
          ),
          fetch("output/video_2/crossmodal_analysis.txt").then((res) =>
            res.text().catch(() => "")
          ),
          fetch("output/compatibility_score.json").then((res) =>
            res.json().catch(() => ({ score: 0 }))
          ),
          fetch("output/compatibility_analysis.txt").then((res) =>
            res.text().catch(() => "")
          ),
        ])
          .then(
            ([
              metrics1,
              metrics2,
              analysis1,
              analysis2,
              scoreData,
              detailedAnalysis,
            ]) => {
              console.log("Data loaded successfully");

              // Prepare time series data
              data1 = prepareTimeSeriesData(metrics1);
              data2 = prepareTimeSeriesData(metrics2);

              // Display analysis text (without word limit)
              document.getElementById("text1").textContent = analysis1;
              document.getElementById("text2").textContent = analysis2;

              // Display compatibility score
              compatibilityScore = scoreData.score;
              document.getElementById(
                "compatibility-score"
              ).textContent = `Date Compatibility Score: ${compatibilityScore}/100`;

              // Display detailed compatibility analysis
              document.getElementById(
                "detailed-analysis"
              ).innerHTML = `<h2>Compatibility Analysis</h2><p>${detailedAnalysis}</p>`;

              // Create charts for each video
              createVideoChart("chart1", data1, "Video 1 Emotional Metrics");
              createVideoChart("chart2", data2, "Video 2 Emotional Metrics");

              // Display metrics images
              metricsImg1.src = "output/video_1/metrics_over_time.png";
              metricsImg1.style.display = "block";

              metricsImg2.src = "output/video_2/metrics_over_time.png";
              metricsImg2.style.display = "block";

              // Update time slider max value
              const maxTime = Math.max(
                data1.length > 0 ? data1.length - 1 : 0,
                data2.length > 0 ? data2.length - 1 : 0
              );
              timeSlider.max = maxTime;

              // Update video sources
              v1.src = "output/video_1.mp4";
              v2.src = "output/video_2.mp4";

              // Hide status indicator after a brief display of success
              setTimeout(() => {
                statusIndicator.style.display = "none";
              }, 2000);
            }
          )
          .catch((err) => {
            console.error("Error loading data:", err);
            statusIndicator.innerHTML =
              "Error loading analysis data. Please try again.";
            statusIndicator.style.backgroundColor = "#f8d7da";
          });
      }

      // Create individual charts for each video
      function createVideoChart(canvasId, data, title) {
        const ctx = document.getElementById(canvasId).getContext("2d");

        // Prepare x-axis labels (time in seconds)
        const labels = Array.from({ length: data.length }, (_, i) => i);

        // Create chart
        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Valence",
                data: data.map((d) => d.valence),
                borderColor: "rgba(255, 99, 132, 1)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                tension: 0.4,
              },
              {
                label: "Comfort",
                data: data.map((d) => d.comfort),
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                tension: 0.4,
              },
              {
                label: "Engagement",
                data: data.map((d) => d.happy + d.surprise),
                borderColor: "rgba(255, 206, 86, 1)",
                backgroundColor: "rgba(255, 206, 86, 0.2)",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: title,
              },
            },
            scales: {
              y: {
                min: -1,
                max: 1,
              },
            },
          },
        });
      }

      // Prepare time series data from metrics JSON
      function prepareTimeSeriesData(metrics) {
        // If no metrics data or empty object, return empty array
        if (!metrics || !metrics.valence || !Array.isArray(metrics.valence)) {
          console.warn("Invalid metrics data format");
          return [];
        }

        // Convert the valence array to array of objects
        const timePoints = metrics.valence.length;
        const timeSeriesData = [];

        for (let i = 0; i < timePoints; i++) {
          timeSeriesData.push({
            valence: metrics.valence[i],
            comfort: metrics.comfort[i],
            saccade: metrics.saccade[i],
            happy: metrics.emotions[i]?.happy || 0,
            surprise: metrics.emotions[i]?.surprise || 0,
            angry: metrics.emotions[i]?.angry || 0,
            disgust: metrics.emotions[i]?.disgust || 0,
            fear: metrics.emotions[i]?.fear || 0,
            sad: metrics.emotions[i]?.sad || 0,
            neutral: metrics.emotions[i]?.neutral || 0,
          });
        }

        return timeSeriesData;
      }

      // Adjust time slider width to match video width
      function adjustSliderWidth() {
        const videoWidth = v1.offsetWidth;
        timeSlider.style.width = videoWidth * 2 + 40 + "px"; // Account for gap between videos
      }

      // Call once on load and again on window resize
      window.addEventListener("load", adjustSliderWidth);
      window.addEventListener("resize", adjustSliderWidth);

      // Time slider functionality
      timeSlider.addEventListener("input", function () {
        const time = parseInt(this.value);
        currentTimeDisplay.textContent = time;

        // Set video times
        if (v1.duration) v1.currentTime = time;
        if (v2.duration) v2.currentTime = time;

        // Update metrics displays
        updateMetrics(time);
      });

      // Play both videos
      playBtn.addEventListener("click", function () {
        v1.play();
        v2.play();
      });

      // Sync videos with time slider
      function updateTimeSlider() {
        const time = Math.floor(v1.currentTime);
        timeSlider.value = time;
        currentTimeDisplay.textContent = time;
        updateMetrics(time);
      }

      v1.addEventListener("timeupdate", updateTimeSlider);

      // Update metrics display
      function updateMetrics(time) {
        if (data1[time]) {
          document.getElementById("val1").textContent =
            data1[time].valence.toFixed(2);
          document.getElementById("com1").textContent =
            data1[time].comfort.toFixed(2);
          document.getElementById("eng1").textContent = (
            data1[time].happy + data1[time].surprise
          ).toFixed(2);
        }

        if (data2[time]) {
          document.getElementById("val2").textContent =
            data2[time].valence.toFixed(2);
          document.getElementById("com2").textContent =
            data2[time].comfort.toFixed(2);
          document.getElementById("eng2").textContent = (
            data2[time].happy + data2[time].surprise
          ).toFixed(2);
        }
      }
    </script>
  </body>
</html>
